# PRIVACY POLICY & DATA MINIMIZATION
**Date**: 2025-01-04  
**Scope**: KEYS Marketplace + Discovery MVP

## Data Collection

### What We Collect

1. **Authentication Data**
   - Email address (required for account)
   - User ID (UUID, generated by Supabase)
   - JWT tokens (stored in httpOnly cookies)

2. **Usage Data**
   - Marketplace views (key pages visited)
   - Discovery signals (role, tool intent, problem category)
   - Download events (key_id, version, timestamp)
   - Purchase events (key_id, amount, timestamp)

3. **Analytics Data**
   - IP address (hashed with SHA256)
   - User agent (truncated to 500 chars)
   - Request IDs (for correlation)
   - Error logs (no PII)

4. **Billing Data**
   - Stripe customer ID
   - Subscription status
   - Purchase history (via Stripe)

### What We DON'T Collect

- ❌ Credit card numbers (handled by Stripe)
- ❌ Passwords (handled by Supabase Auth)
- ❌ Full IP addresses (hashed)
- ❌ Full user agents (truncated)
- ❌ Browser fingerprinting
- ❌ Third-party tracking pixels (except Sentry for errors)

## Data Minimization

### IP Address Hashing
**Implementation**: `backend/src/lib/marketplace/storage.ts`
```typescript
export function hashIP(ip: string): string {
  return createHash('sha256').update(ip).digest('hex');
}
```
- IP addresses are hashed with SHA256 before storage
- Cannot be reversed to original IP
- Used for abuse detection only

### User Agent Truncation
**Implementation**: `backend/src/lib/marketplace/storage.ts`
```typescript
export function truncateUserAgent(ua: string, maxLength: number = 500): string {
  if (ua.length <= maxLength) {
    return ua;
  }
  return ua.substring(0, maxLength - 3) + '...';
}
```
- User agents truncated to 500 characters
- Prevents storage of excessive data

### Logging Redaction
- No PII in structured logs
- Request bodies not logged by default
- Error messages sanitized (no secrets)

## Data Retention

### Download Events
- **Retention**: Indefinite (for analytics)
- **PII**: IP hash, truncated user agent
- **Purpose**: Abuse detection, analytics

### Discovery Signals
- **Retention**: Indefinite (for recommendations)
- **PII**: None (signals are anonymized)
- **Purpose**: Personalization

### Analytics Events
- **Retention**: Indefinite
- **PII**: User ID (for attribution)
- **Purpose**: Business intelligence

### Error Logs
- **Retention**: 90 days (Sentry default)
- **PII**: User ID (for debugging)
- **Purpose**: Error tracking

## User Rights (DSAR Support)

### Right to Access
- Users can view their data via:
  - `/marketplace/entitlements` - Own entitlements
  - `/account` - Profile data
  - Stripe portal - Billing data

### Right to Deletion
**Current Status**: ⚠️ Not fully implemented
- User deletion should:
  1. Delete user profile
  2. Anonymize analytics events (keep for aggregate stats)
  3. Delete entitlements (or mark as deleted)
  4. Cancel Stripe subscriptions
  5. Delete download events (or anonymize)

**Action Required**: Implement user deletion endpoint

### Right to Portability
- Users can export their data via:
  - `/export` endpoint (if implemented)
  - Direct database access (admin only)

### Right to Rectification
- Users can update profile via `/profile` endpoint
- Entitlements cannot be modified by users (admin only)

## Data Sharing

### Third-Party Services

1. **Supabase**
   - Hosts database and auth
   - Data stored in EU/US (configurable)
   - SOC 2 compliant

2. **Stripe**
   - Processes payments
   - PCI DSS compliant
   - No card data stored by us

3. **Sentry**
   - Error tracking
   - Data stored in US/EU
   - SOC 2 compliant

4. **Vercel** (if used)
   - Hosts frontend
   - Edge locations worldwide
   - GDPR compliant

### No Data Sales
- ❌ We do not sell user data
- ❌ We do not share data with advertisers
- ✅ Data only shared with service providers (Supabase, Stripe, Sentry)

## Security Measures

1. **Encryption**
   - HTTPS for all traffic
   - Database encryption at rest (Supabase)
   - Signed URLs for downloads (expire after 1 hour)

2. **Access Control**
   - RLS policies enforce tenant isolation
   - Service role key (backend only)
   - Admin-only endpoints protected

3. **Audit Logging**
   - All admin actions logged
   - Download events logged
   - Webhook events logged

## Compliance

### GDPR
- ✅ Data minimization
- ✅ Right to access (partial)
- ⚠️ Right to deletion (needs implementation)
- ✅ Privacy by design

### CCPA
- ✅ No sale of personal information
- ✅ Right to know (via endpoints)
- ⚠️ Right to delete (needs implementation)

## Recommendations

1. **Implement User Deletion**
   - Add `/account/delete` endpoint
   - Anonymize (don't delete) analytics for aggregate stats
   - Cancel Stripe subscriptions

2. **Add Privacy Policy Page**
   - Frontend page explaining data collection
   - Link in footer

3. **Add Cookie Consent** (if required)
   - For EU users
   - Only if using non-essential cookies

4. **Data Export**
   - Implement `/export` endpoint
   - Export user data as JSON

5. **Audit Log Access**
   - Allow users to view their audit log
   - Show what data was accessed when
