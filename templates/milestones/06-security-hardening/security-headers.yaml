id: security-headers
milestone: 06-security-hardening
name: Security Headers Middleware
description: Helmet.js or equivalent security headers middleware for Express/Fastify
priority: high
dependencies: [init-project-structure]
tags: [security, headers, middleware]
stack: [express, fastify, node]
security_level: required
optimization_level: optional

content: |
  import { Request, Response, NextFunction } from 'express';
  import helmet from 'helmet';

  /**
   * Security Headers Middleware
   * 
   * SECURITY CONSIDERATIONS:
   * - Content Security Policy (CSP) prevents XSS attacks
   * - X-Frame-Options prevents clickjacking
   * - X-Content-Type-Options prevents MIME sniffing
   * - Strict-Transport-Security enforces HTTPS
   * - Referrer-Policy controls referrer information leakage
   * - Permissions-Policy restricts browser features
   * 
   * OPTIMIZATION:
   * - Headers add minimal overhead (~100-200 bytes per response)
   * - CSP can be tuned for optimal performance vs security
   */
  export function securityMiddleware() {
    return helmet({
      contentSecurityPolicy: {
        directives: {
          defaultSrc: ["'self'"],
          styleSrc: ["'self'", "'unsafe-inline'"], // 'unsafe-inline' for Next.js/Tailwind
          scriptSrc: ["'self'"],
          imgSrc: ["'self'", 'data:', 'https:'],
          connectSrc: ["'self'", 'https://api.{{api_domain}}'],
          fontSrc: ["'self'", 'data:'],
          objectSrc: ["'none'"],
          mediaSrc: ["'self'"],
          frameSrc: ["'none'"],
          upgradeInsecureRequests: process.env.NODE_ENV === 'production' ? [] : null,
        },
      },
      crossOriginEmbedderPolicy: false, // Disable if using third-party scripts
      crossOriginResourcePolicy: { policy: 'cross-origin' },
      crossOriginOpenerPolicy: { policy: 'same-origin' },
      dnsPrefetchControl: true,
      frameguard: { action: 'deny' },
      hidePoweredBy: true,
      hsts: {
        maxAge: 31536000, // 1 year
        includeSubDomains: true,
        preload: true,
      },
      ieNoOpen: true,
      noSniff: true,
      originAgentCluster: true,
      permittedCrossDomainPolicies: false,
      referrerPolicy: { policy: 'strict-origin-when-cross-origin' },
      xssFilter: true,
    });
  }

  /**
   * Additional security headers for API endpoints
   */
  export function apiSecurityHeaders() {
    return (req: Request, res: Response, next: NextFunction): void => {
      // Prevent caching of sensitive API responses
      res.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, private');
      res.setHeader('Pragma', 'no-cache');
      res.setHeader('Expires', '0');
      
      // API-specific headers
      res.setHeader('X-Content-Type-Options', 'nosniff');
      res.setHeader('X-Frame-Options', 'DENY');
      res.setHeader('X-XSS-Protection', '1; mode=block');
      
      next();
    };
  }

variables:
  - name: api_domain
    description: API domain for CSP connect-src
    required: false
    default: "example.com"
    examples:
      - "api.example.com"
      - "api.supabase.co"
      - "your-api.vercel.app"
