name: Database Migrations

on:
  push:
    branches:
      - main
    paths:
      - 'backend/supabase/migrations/**/*.sql'
      - 'scripts/run-all-migrations.ts'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force run all migrations (ignore tracking)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  detect-and-run-migrations:
    name: Detect and Run Migrations
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install
          cd backend && npm install

      - name: Run migrations using TypeScript runner
        id: run-migrations
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ðŸš€ Running migrations using TypeScript runner..."
          echo "ðŸ“Š Using SUPABASE_URL from GitHub Secrets"
          echo "ðŸ”‘ Using SUPABASE_SERVICE_ROLE_KEY from GitHub Secrets"
          
          cd backend
          npm run migrate
          
          # Check exit code
          if [ $? -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "âœ… All migrations completed successfully"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "âŒ Migrations failed"
            exit 1
          fi

      - name: Verify migrations
        if: steps.run-migrations.outputs.success == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          echo "ðŸ” Verifying migrations..."
          tsx scripts/verify-migrations.ts || echo "Verification skipped"

      - name: Create migration report
        if: always()
        run: |
          echo "## ðŸ”„ Migration Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.run-migrations.outputs.success }}" == "true" ]; then
            echo "âœ… **Status:** Migrations completed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All pending migrations have been applied." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Status:** Migrations failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi
