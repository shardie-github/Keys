name: CI - Build, Test & Visual Regression

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      update_baselines:
        description: 'Update visual baseline screenshots'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PLAYWRIGHT_VERSION: '1.58.0'

jobs:
  # Job 1: Lint and Type Check
  lint-and-typecheck:
    name: üîç Lint & Type Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript check
        run: npm run type-check

  # Job 2: Build
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    needs: lint-and-typecheck
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: frontend/.next/
          retention-days: 1

  # Job 3: Functional E2E Tests
  e2e-functional:
    name: üß™ Functional E2E Tests
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium firefox webkit

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: frontend/.next/

      - name: Run functional E2E tests
        run: npm run test:e2e -- --project=chromium --project=firefox --project=webkit
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-functional
          path: frontend/playwright-report/
          retention-days: 7

  # Job 4: Visual Regression Tests
  visual-regression:
    name: üì∏ Visual Regression Tests
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: frontend/.next/

      - name: Start dev server
        run: npm run dev &
        env:
          PORT: 3000

      - name: Wait for server
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Run visual regression tests
        run: |
          if [ "${{ github.event.inputs.update_baselines }}" = "true" ]; then
            npm run test:visual:update
          else
            npm run test:visual
          fi
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload visual test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-results
          path: |
            frontend/playwright-report/
            frontend/e2e/__screenshots__/
          retention-days: 7

      - name: Upload baseline screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-baseline-compare
          path: |
            frontend/e2e/__screenshots__/**/*.png
            frontend/test-results/
          retention-days: 7

  # Job 5: UI Consistency Audit
  ui-audit:
    name: üîç UI Consistency Audit
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files
          path: frontend/.next/

      - name: Run UI consistency audit
        run: npm run test:audit
        env:
          PLAYWRIGHT_BASE_URL: http://localhost:3000

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-audit-report
          path: |
            frontend/e2e/audit-report.json
            frontend/playwright-report/
          retention-days: 30

  # Job 6: Summary
  summary:
    name: üìã Summary
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck, build, e2e-functional, visual-regression, ui-audit]
    if: always()

    steps:
      - name: Job results
        run: |
          echo "Lint & Type Check: ${{ needs.lint-and-typecheck.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Functional E2E: ${{ needs.e2e-functional.result }}"
          echo "Visual Regression: ${{ needs.visual-regression.result }}"
          echo "UI Audit: ${{ needs.ui-audit.result }}"

      - name: Check all passed
        if: |
          needs.lint-and-typecheck.result != 'success' ||
          needs.build.result != 'success' ||
          needs.e2e-functional.result != 'success' ||
          needs.visual-regression.result != 'success' ||
          needs.ui-audit.result != 'success'
        run: |
          echo "‚ùå One or more jobs failed"
          exit 1
